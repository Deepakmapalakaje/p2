# TrendVision Fresh VM Deployment Commands
# Target VM: instance-20250921-125329 (asia-south1-b, 34.93.113.19)
# Run these commands sequentially from Windows PowerShell after updating DNS records.

# DNS propagation check (repeat until the address resolves to 34.93.113.19)
nslookup trendvision2004.com

# Step 1: Update package index and upgrade base system
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo apt update && sudo apt upgrade -y"

# Step 2: Install required system packages
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo apt install -y python3 python3-pip python3-venv nginx certbot python3-certbot-nginx git htop curl unzip build-essential"

# Step 3: Create dedicated system user
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo adduser --system --group --no-create-home trendvision"

# Step 4: Prepare application directory ownership
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo mkdir -p /opt/trendvision && sudo chown $USER:$USER /opt/trendvision"

# Step 5: Clone the TrendVision repository
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cd /opt/trendvision && git clone https://github.com/Deepakmapalakaje/TrendVision.git ."

# Step 6: Create virtual environment and install Python dependencies
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cd /opt/trendvision && python3 -m venv venv && source venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt && deactivate"

# Step 7: Create application directories
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cd /opt/trendvision && mkdir -p config database logs"

# Step 8: Create production configuration file
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cd /opt/trendvision && echo '{\"ACCESS_TOKEN\": \"update-daily-in-admin-panel\", \"NIFTY_FUTURE_key\": \"NSE_FO|53001\"}' > config/config.json"

# Step 9: Create environment file
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cd /opt/trendvision && cat > .env << 'EOF'
FLASK_SECRET_KEY=trendvision-enhanced-production-key-2024
TRADING_DB=database/upstox_v3_live_trading.db
USER_DB=database/users.db
PORT=8080
FLASK_ENV=production
RUN_PIPELINE=1
SENDER_EMAIL=dscatreeing@gmail.com
SENDER_PASSWORD=lszl urfy lhlm vshz
EOF"

# Step 10: Create systemd service for the web application
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo tee /etc/systemd/system/trendvision-web.service << 'EOF'
[Unit]
Description=TrendVision Web Application - Enhanced Version
After=network.target

[Service]
Type=simple
User=trendvision
Group=trendvision
WorkingDirectory=/opt/trendvision
Environment=PATH=/opt/trendvision/venv/bin
Environment=PYTHONPATH=/opt/trendvision
ExecStart=/opt/trendvision/venv/bin/python app.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
KillMode=mixed
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
EOF"

# Step 11: Create systemd service for the trading pipeline
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo tee /etc/systemd/system/trendvision-pipeline.service << 'EOF'
[Unit]
Description=TrendVision Trading Pipeline - Enhanced Version
After=network.target

[Service]
Type=simple
User=trendvision
Group=trendvision
WorkingDirectory=/opt/trendvision
Environment=PATH=/opt/trendvision/venv/bin
Environment=PYTHONPATH=/opt/trendvision
ExecStart=/opt/trendvision/venv/bin/python pipeline1.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
KillMode=mixed
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
EOF"

# Step 12: Create nginx configuration
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo tee /etc/nginx/sites-available/trendvision2004.com << 'EOF'
server {
    listen 80;
    server_name trendvision2004.com www.trendvision2004.com;

    add_header X-Frame-Options \"SAMEORIGIN\" always;
    add_header X-XSS-Protection \"1; mode=block\" always;
    add_header X-Content-Type-Options \"nosniff\" always;
    add_header Referrer-Policy \"no-referrer-when-downgrade\" always;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-Host \$host;
        proxy_set_header X-Forwarded-Port \$server_port;

        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection \"upgrade\";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location /static/ {
        alias /opt/trendvision/static/;
        expires 1y;
        add_header Cache-Control \"public, immutable\";
        access_log off;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        add_header Cache-Control \"no-cache, no-store, must-revalidate\";
        add_header Pragma \"no-cache\";
        add_header Expires \"0\";
    }
}
EOF"

# Step 13: Enable nginx site and remove default
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo ln -s /etc/nginx/sites-available/trendvision2004.com /etc/nginx/sites-enabled/ && sudo rm -f /etc/nginx/sites-enabled/default"

# Step 14: Test nginx configuration and restart
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo nginx -t && sudo systemctl restart nginx"

# Step 15: Apply application ownership and executable permissions
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo chown -R trendvision:trendvision /opt/trendvision && sudo chmod +x /opt/trendvision/*.py"

# Step 16: Create logrotate configuration
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo tee /etc/logrotate.d/trendvision << 'EOF'
/opt/trendvision/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 trendvision trendvision
    postrotate
        systemctl reload trendvision-web
        systemctl reload trendvision-pipeline
    endscript
}
EOF"

# Step 17: Obtain and install SSL certificates
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo certbot --nginx -d trendvision2004.com -d www.trendvision2004.com --email admin@trendvision2004.com --agree-tos --non-interactive --redirect"

# Step 18: Enable and start services
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo systemctl daemon-reload && sudo systemctl enable trendvision-web trendvision-pipeline && sudo systemctl start trendvision-web trendvision-pipeline"

# Step 19: Verify service status (web, pipeline, nginx)
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo systemctl status trendvision-web --no-pager && sudo systemctl status trendvision-pipeline --no-pager && sudo systemctl status nginx --no-pager"

# Step 20: Review recent pipeline logs for startup confirmation
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="sudo journalctl -u trendvision-pipeline --since '5 minutes ago' --no-pager"

# Step 21: Create admin helper script
gcloud compute ssh instance-20250921-125329 --zone=asia-south1-b --command="cat > ~/trendvision-admin.sh << 'EOF'
#!/bin/bash
echo 'TrendVision Admin Commands'
echo '1. Check web status: sudo systemctl status trendvision-web'
echo '2. Check pipeline status: sudo systemctl status trendvision-pipeline'
echo '3. View web logs: sudo journalctl -u trendvision-web -f'
echo '4. View pipeline logs: sudo journalctl -u trendvision-pipeline -f'
echo '5. Restart web: sudo systemctl restart trendvision-web'
echo '6. Restart pipeline: sudo systemctl restart trendvision-pipeline'
echo '7. Admin panel: https://trendvision2004.com/admin/login'
echo '8. Credentials: dsar / dsar'
EOF
chmod +x ~/trendvision-admin.sh"

# Step 22: Test HTTP to HTTPS redirect from local machine
curl -I http://trendvision2004.com

# Step 23: Test HTTPS responses from local machine
curl -I https://trendvision2004.com

# Step 24: Test admin login page availability
curl -I https://trendvision2004.com/admin/login

# Post-deployment: Log in to the admin panel, update the daily access token, fetch instruments, extract options, and confirm the pipeline is running.
